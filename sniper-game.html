<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sniper Warzone</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;overflow:hidden;font-family:Consolas,monospace}
canvas{position:fixed;inset:0;display:block}
#ui{position:fixed;inset:0;pointer-events:none;z-index:10}
#topbar{position:absolute;top:14px;left:50%;transform:translateX(-50%);font-size:11px;letter-spacing:3px;color:#b7d6a9;text-shadow:0 0 6px #4a7d35;opacity:.65}
#hud{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);display:flex;gap:34px}
.hud-item{text-align:center;color:#b7d6a9;text-shadow:0 0 8px #4a7d35}
.hud-label{font-size:9px;letter-spacing:2px;opacity:.6}
.hud-value{font-size:23px;font-weight:700;letter-spacing:1px}
#ally{position:absolute;top:52px;left:20px;color:#99ccff;text-shadow:0 0 7px #35648b;font-size:10px;letter-spacing:2px}
#scope{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:320px;height:320px;display:none}
#scope svg{width:100%;height:100%}
#vignette{position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,transparent 138px,rgba(0,0,0,.98) 198px);display:none}
#crosshair{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:20px;height:20px}
#crosshair:before,#crosshair:after{content:"";position:absolute;background:rgba(255,255,255,.9)}
#crosshair:before{width:20px;height:1px;top:50%}
#crosshair:after{width:1px;height:20px;left:50%}
#hitmarker{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:30px;height:30px;opacity:0}
#hitmarker:before,#hitmarker:after{content:"";position:absolute;background:#ff4747}
#hitmarker:before{width:100%;height:2px;top:50%}
#hitmarker:after{width:2px;height:100%;left:50%}
#hitmarker.flash{animation:hm .25s forwards}
@keyframes hm{from{opacity:1}to{opacity:0}}
#flash{position:absolute;inset:0;background:#fff;opacity:0}
#flash.bang{animation:bang .13s forwards}
@keyframes bang{from{opacity:.34}to{opacity:0}}
#killfeed{position:absolute;top:24px;right:22px;display:flex;flex-direction:column;gap:6px;align-items:flex-end}
.kill{font-size:11px;letter-spacing:2px;color:#ff6d6d;text-shadow:0 0 8px #f33;animation:kfade 2.5s forwards}
@keyframes kfade{0%{opacity:1;transform:translateX(0)}100%{opacity:0;transform:translateX(20px)}}
#breath-wrap{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);display:none;align-items:center;gap:8px;color:#b7d6a9;font-size:9px;letter-spacing:2px}
#breath-bg{width:96px;height:5px;background:rgba(255,255,255,.15);border-radius:3px;overflow:hidden}
#breath{width:100%;height:100%;background:#4a8f3d}
#reload-msg{position:absolute;bottom:118px;left:50%;transform:translateX(-50%);color:#ffd56d;font-size:10px;letter-spacing:3px;text-shadow:0 0 8px #ff9800;display:none}
#reload-bar-wrap{position:absolute;bottom:102px;left:50%;transform:translateX(-50%);width:160px;height:7px;border-radius:999px;background:rgba(0,0,0,.55);border:1px solid rgba(255,213,109,.45);overflow:hidden;display:none}
#reload-bar{width:0;height:100%;background:linear-gradient(90deg,#f8af4b,#ffe39c)}
#weapon{position:absolute;right:46px;bottom:24px;width:205px;height:96px;opacity:.92;transition:transform .08s linear}
#weapon-body{position:absolute;right:0;bottom:0;width:136px;height:42px;border-radius:12px 6px 10px 8px;background:linear-gradient(160deg,#2b333b,#11161b)}
#weapon-scope{position:absolute;right:36px;bottom:31px;width:65px;height:18px;border-radius:9px;background:linear-gradient(160deg,#303c48,#121920)}
#weapon-barrel{position:absolute;right:128px;bottom:15px;width:78px;height:10px;border-radius:8px;background:linear-gradient(160deg,#2d3741,#151b22)}
#muzzle{position:absolute;right:198px;bottom:11px;width:28px;height:28px;border-radius:50%;background:radial-gradient(circle,rgba(255,228,152,.98) 0%,rgba(255,162,63,.55) 55%,transparent 80%);opacity:0;transform:scale(.7)}
#muzzle.flash{animation:muz .09s forwards}
@keyframes muz{from{opacity:1;transform:scale(.75)}to{opacity:0;transform:scale(1.3)}}
#weapon.recoil{animation:kick .14s ease-out}
@keyframes kick{0%{transform:translate(0,0) rotate(0)}45%{transform:translate(9px,8px) rotate(2.5deg)}100%{transform:translate(0,0) rotate(0)}}
#lock{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.66);pointer-events:auto;cursor:pointer}
#lock h1{font-size:30px;letter-spacing:10px;color:#b7d6a9;text-shadow:0 0 16px #4a7d35;margin-bottom:12px}
#lock p{font-size:10px;line-height:2;color:rgba(255,255,255,.48);text-align:center;letter-spacing:2px}
#help{position:absolute;bottom:90px;left:24px;font-size:9px;line-height:2;color:rgba(255,255,255,.25);letter-spacing:2px}
</style>
</head>
<body>
<div id="ui">
  <div id="vignette"></div>
  <div id="scope"><svg viewBox="0 0 320 320" fill="none"><circle cx="160" cy="160" r="156" stroke="rgba(180,220,160,.55)"/><circle cx="160" cy="160" r="122" stroke="rgba(180,220,160,.2)"/><line x1="0" y1="160" x2="100" y2="160" stroke="rgba(180,220,160,.8)"/><line x1="220" y1="160" x2="320" y2="160" stroke="rgba(180,220,160,.8)"/><line x1="160" y1="0" x2="160" y2="100" stroke="rgba(180,220,160,.8)"/><line x1="160" y1="220" x2="160" y2="320" stroke="rgba(180,220,160,.8)"/><circle cx="160" cy="160" r="2" fill="rgba(255,60,60,.95)"/></svg></div>
  <div id="crosshair"></div>
  <div id="hitmarker"></div>
  <div id="flash"></div>
  <div id="topbar">SNIPER - EXPANDED WARZONE - ALLY SUPPORT ACTIVE</div>
  <div id="hud">
    <div class="hud-item"><div class="hud-label">KILLS</div><div class="hud-value" id="kills">0</div></div>
    <div class="hud-item"><div class="hud-label">AMMO</div><div class="hud-value" id="ammo">6 / 36</div></div>
    <div class="hud-item"><div class="hud-label">DISTANCE</div><div class="hud-value" id="distance">- m</div></div>
  </div>
  <div id="ally">ALLY: <span id="ally-state">ONLINE</span></div>
  <div id="breath-wrap"><span>BREATH</span><div id="breath-bg"><div id="breath"></div></div></div>
  <div id="reload-msg">RELOADING 0%</div>
  <div id="reload-bar-wrap"><div id="reload-bar"></div></div>
  <div id="weapon"><div id="muzzle"></div><div id="weapon-barrel"></div><div id="weapon-scope"></div><div id="weapon-body"></div></div>
  <div id="killfeed"></div>
  <div id="lock"><h1>SNIPER</h1><p>CLICK TO LOCK MOUSE AND PLAY<br><br>WASD MOVE  |  MOUSE AIM<br>RMB SCOPE  |  LMB FIRE<br>SHIFT HOLD BREATH  |  R RELOAD<br>ALLY SUPPORT HELPS SHOOT ENEMIES</p></div>
  <div id="help">WASD MOVE<br>RMB SCOPE<br>LMB FIRE<br>SHIFT BREATH<br>R RELOAD</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
"use strict";
const ui={kills:document.getElementById("kills"),ammo:document.getElementById("ammo"),distance:document.getElementById("distance"),allyState:document.getElementById("ally-state"),scope:document.getElementById("scope"),vignette:document.getElementById("vignette"),crosshair:document.getElementById("crosshair"),breathWrap:document.getElementById("breath-wrap"),breath:document.getElementById("breath"),hitmarker:document.getElementById("hitmarker"),flash:document.getElementById("flash"),reloadMsg:document.getElementById("reload-msg"),reloadWrap:document.getElementById("reload-bar-wrap"),reloadBar:document.getElementById("reload-bar"),weapon:document.getElementById("weapon"),muzzle:document.getElementById("muzzle"),killfeed:document.getElementById("killfeed"),lock:document.getElementById("lock")};
const MAP=900, HALF=MAP/2, PLAYER_H=1.72, LIMIT=HALF-15, SAFE=28, RELOAD_MS=2200;
const renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(Math.min(devicePixelRatio,2));renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.08;document.body.appendChild(renderer.domElement);
const scene=new THREE.Scene();scene.fog=new THREE.FogExp2(0xb5d2df,.0039);
const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.05,1400);camera.position.set(0,PLAYER_H,0);scene.add(camera);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));const rr=(a,b)=>a+Math.random()*(b-a);
function normA(a){while(a>Math.PI)a-=Math.PI*2;while(a<-Math.PI)a+=Math.PI*2;return a}
function terrainY(x,z){let y=Math.sin(x*.012)*Math.cos(z*.011)*8.6+Math.sin(x*.024+2.4)*Math.cos(z*.022+1.5)*3.8+Math.sin(x*.061+4.3)*Math.cos(z*.052+2.9)*1.35;const d=Math.hypot(x,z);if(d<58)y*=d/58;return y}
function feed(msg,c){const d=document.createElement("div");d.className="kill";d.textContent=msg;if(c)d.style.color=c;ui.killfeed.appendChild(d);setTimeout(()=>d.remove(),2500)}
scene.add(new THREE.AmbientLight(0x8faec8,.72));
const sun=new THREE.DirectionalLight(0xfff4dc,2.35);sun.position.set(130,170,50);sun.castShadow=true;sun.shadow.mapSize.set(2048,2048);sun.shadow.camera.left=-340;sun.shadow.camera.right=340;sun.shadow.camera.top=340;sun.shadow.camera.bottom=-340;sun.shadow.camera.far=900;sun.shadow.bias=-.0003;scene.add(sun);
const fill=new THREE.DirectionalLight(0x5f85b6,.42);fill.position.set(-90,50,-100);scene.add(fill);
scene.add(new THREE.Mesh(new THREE.SphereGeometry(1200,24,12),new THREE.ShaderMaterial({side:THREE.BackSide,uniforms:{top:{value:new THREE.Color(0x0f4c90)},bottom:{value:new THREE.Color(0xbcd9e4)}},vertexShader:"varying vec3 vP;void main(){vP=(modelMatrix*vec4(position,1.)).xyz;gl_Position=projectionMatrix*viewMatrix*modelMatrix*vec4(position,1.);}",fragmentShader:"uniform vec3 top,bottom;varying vec3 vP;void main(){float h=normalize(vP).y;gl_FragColor=vec4(mix(bottom,top,max(pow(max(h,0.),.52),0.)),1.);}"})));
const tGeo=new THREE.PlaneGeometry(MAP,MAP,180,180);tGeo.rotateX(-Math.PI/2);const tp=tGeo.attributes.position;for(let i=0;i<tp.count;i++)tp.setY(i,terrainY(tp.getX(i),tp.getZ(i)));tGeo.computeVertexNormals();const terrain=new THREE.Mesh(tGeo,new THREE.MeshLambertMaterial({color:0x365f23}));terrain.receiveShadow=true;scene.add(terrain);
const world=new THREE.Group();scene.add(world);
for(let i=0;i<150;i++){const x=rr(-HALF+15,HALF-15),z=rr(-HALF+15,HALF-15);if(Math.hypot(x,z)<SAFE+6)continue;const s=rr(.7,4.4);const g=new THREE.DodecahedronGeometry(s,0),v=g.attributes.position;for(let j=0;j<v.count;j++){v.setX(j,v.getX(j)+rr(-s*.32,s*.32));v.setY(j,v.getY(j)+rr(-s*.22,s*.22));v.setZ(j,v.getZ(j)+rr(-s*.32,s*.32));}g.computeVertexNormals();const m=new THREE.Mesh(g,new THREE.MeshLambertMaterial({color:new THREE.Color(rr(.3,.46),rr(.28,.38),rr(.24,.34))}));m.position.set(x,terrainY(x,z)+s*.45,z);m.rotation.set(rr(0,Math.PI*2),rr(0,Math.PI*2),rr(0,Math.PI*2));m.castShadow=m.receiveShadow=true;world.add(m)}
const trunkGeo=new THREE.CylinderGeometry(.11,.2,1,7),leafA=new THREE.ConeGeometry(1.4,2.5,8),leafB=new THREE.ConeGeometry(1,2,8);
for(let i=0;i<420;i++){const x=rr(-HALF+20,HALF-20),z=rr(-HALF+20,HALF-20);if(Math.hypot(x,z)<SAFE+14)continue;const g=new THREE.Group(),h=rr(3.2,8.4),y=terrainY(x,z);const t=new THREE.Mesh(trunkGeo,new THREE.MeshLambertMaterial({color:0x5a3a1d}));t.scale.y=h;t.position.y=h*.5;t.castShadow=true;g.add(t);const c=Math.random()<.5?0x214f1b:0x2a5f24,mat=new THREE.MeshLambertMaterial({color:c});const a=new THREE.Mesh(leafA,mat);a.position.y=h*.8+1.5;a.scale.setScalar(rr(.8,1.25));a.castShadow=true;g.add(a);const b=new THREE.Mesh(leafB,mat);b.position.y=h*.8+2.8;b.scale.setScalar(rr(.75,1.2));b.castShadow=true;g.add(b);g.position.set(x,y,z);world.add(g)}
const grassCnt=8500,gBlade=new THREE.PlaneBufferGeometry(.16,.9);gBlade.translate(0,.45,0);const gMat=new THREE.MeshLambertMaterial({color:0x4f9530,side:THREE.DoubleSide,transparent:true,opacity:.95});const grass=new THREE.InstancedMesh(gBlade,gMat,grassCnt),dummy=new THREE.Object3D();for(let i=0;i<grassCnt;i++){const x=rr(-HALF+16,HALF-16),z=rr(-HALF+16,HALF-16),y=terrainY(x,z);dummy.position.set(x,y,z);dummy.rotation.set(rr(-.08,.08),rr(0,Math.PI*2),0);const s=rr(.7,1.4);dummy.scale.set(s,rr(.75,1.5),s);dummy.updateMatrix();grass.setMatrixAt(i,dummy.matrix);if(grass.setColorAt){grass.setColorAt(i,new THREE.Color().setHSL(rr(.25,.33),rr(.45,.68),rr(.3,.42)))} }grass.instanceMatrix.needsUpdate=true;if(grass.instanceColor)grass.instanceColor.needsUpdate=true;scene.add(grass);
const bAnch=[];function building(x,z){const g=new THREE.Group(),w=rr(6,14),d=rr(6,14),h=rr(7,24),y=terrainY(x,z);const body=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshLambertMaterial({color:0x5e646a}));body.position.y=h*.5;body.castShadow=body.receiveShadow=true;g.add(body);const roof=new THREE.Mesh(new THREE.BoxGeometry(w*1.02,.6,d*1.02),new THREE.MeshLambertMaterial({color:0x3f4348}));roof.position.y=h+.3;roof.castShadow=true;g.add(roof);for(let i=0;i<Math.floor(rr(1,4));i++){const deb=new THREE.Mesh(new THREE.BoxGeometry(rr(.7,2),rr(.4,1.3),rr(.7,2.4)),new THREE.MeshLambertMaterial({color:0x474c50}));deb.position.set(rr(-w*.5,w*.5),rr(.2,1.1),rr(-d*.5,d*.5));deb.rotation.set(rr(-.4,.4),rr(0,Math.PI*2),rr(-.4,.4));deb.castShadow=true;g.add(deb)}g.position.set(x,y,z);g.rotation.y=rr(0,Math.PI*2);world.add(g);bAnch.push({x,z})}
function car(x,z){const g=new THREE.Group(),y=terrainY(x,z);const cols=[0x5f2f2f,0x2d3f57,0x414141,0x645f34],c=cols[Math.floor(Math.random()*cols.length)];const body=new THREE.Mesh(new THREE.BoxGeometry(2.7,.65,1.3),new THREE.MeshLambertMaterial({color:c}));body.position.y=.55;body.castShadow=true;g.add(body);const cab=new THREE.Mesh(new THREE.BoxGeometry(1.5,.55,1.05),new THREE.MeshLambertMaterial({color:0x7fa0b8,transparent:true,opacity:.6}));cab.position.y=1.02;cab.castShadow=true;g.add(cab);for(const sx of [-1,1])for(const sz of[-.55,.55]){const wh=new THREE.Mesh(new THREE.CylinderGeometry(.25,.25,.24,10),new THREE.MeshLambertMaterial({color:0x1f1f1f}));wh.rotation.z=Math.PI/2;wh.position.set(sx,.27,sz);wh.castShadow=true;g.add(wh)}if(Math.random()<.45){const burn=new THREE.Mesh(new THREE.BoxGeometry(.8,.2,.55),new THREE.MeshLambertMaterial({color:0x1f1f1f}));burn.position.set(rr(-.6,.6),1.2,rr(-.3,.3));burn.rotation.set(rr(-.5,.5),rr(-.5,.5),rr(-.5,.5));g.add(burn)}g.position.set(x,y+.02,z);g.rotation.y=rr(0,Math.PI*2);world.add(g)}
for(let i=0;i<46;i++){const a=Math.random()*Math.PI*2,r=rr(150,HALF-32);building(Math.cos(a)*r,Math.sin(a)*r)}for(let i=0;i<34;i++){const a=bAnch[Math.floor(Math.random()*bAnch.length)];car(a.x+rr(-18,18),a.z+rr(-18,18))}
const TYPES=[{id:"rifle",role:"RIFLEMAN",hp:110,s0:.65,s1:1.08,body:0x556b2f,limb:0x485b2a,helm:0x3a4a20,sc:1},{id:"heavy",role:"HEAVY",hp:180,s0:.42,s1:.75,body:0x5a5d3a,limb:0x4a4b30,helm:0x40422f,sc:1.16},{id:"scout",role:"SCOUT",hp:88,s0:1,s1:1.46,body:0x507063,limb:0x314a45,helm:0x29423c,sc:.92}];
const pick=()=>{const r=Math.random();if(r<.2)return TYPES[1];if(r<.48)return TYPES[2];return TYPES[0]};
function enemyMesh(t){const g=new THREE.Group(),skin=new THREE.MeshLambertMaterial({color:0xd7b183}),limb=new THREE.MeshLambertMaterial({color:t.limb}),bodyM=new THREE.MeshLambertMaterial({color:t.body}),helmM=new THREE.MeshLambertMaterial({color:t.helm}),gunM=new THREE.MeshLambertMaterial({color:0x171717});const hips=new THREE.Mesh(new THREE.BoxGeometry(.44,.35,.3),limb);hips.position.y=.86;g.add(hips);const torso=new THREE.Mesh(new THREE.BoxGeometry(.54,.76,.34),bodyM);torso.position.y=1.35;torso.castShadow=true;g.add(torso);const llp=new THREE.Group();llp.position.set(-.16,.72,0);const ll=new THREE.Mesh(new THREE.CylinderGeometry(.09,.09,.76,7),limb);ll.position.y=-.38;ll.castShadow=true;llp.add(ll);g.add(llp);const rlp=new THREE.Group();rlp.position.set(.16,.72,0);const rl=new THREE.Mesh(new THREE.CylinderGeometry(.09,.09,.76,7),limb);rl.position.y=-.38;rl.castShadow=true;rlp.add(rl);g.add(rlp);const lap=new THREE.Group();lap.position.set(-.34,1.52,.02);const la=new THREE.Mesh(new THREE.CylinderGeometry(.065,.065,.62,6),limb);la.position.y=-.3;la.castShadow=true;lap.add(la);g.add(lap);const rap=new THREE.Group();rap.position.set(.34,1.52,.15);const ra=new THREE.Mesh(new THREE.CylinderGeometry(.065,.065,.62,6),limb);ra.position.y=-.3;ra.castShadow=true;rap.add(ra);const rifle=new THREE.Mesh(new THREE.BoxGeometry(.08,.08,.95),gunM);rifle.position.set(.14,-.12,.48);rifle.rotation.x=-.2;rap.add(rifle);g.add(rap);const neck=new THREE.Mesh(new THREE.CylinderGeometry(.08,.09,.18,8),skin);neck.position.y=1.78;g.add(neck);const head=new THREE.Mesh(new THREE.SphereGeometry(.22,12,10),skin);head.position.y=2.03;head.castShadow=true;g.add(head);const helm=new THREE.Mesh(new THREE.SphereGeometry(.26,12,10,0,Math.PI*2,0,Math.PI*.62),helmM);helm.position.y=2.08;helm.castShadow=true;g.add(helm);if(t.id==="heavy"){const armr=new THREE.Mesh(new THREE.BoxGeometry(.74,.58,.4),new THREE.MeshLambertMaterial({color:0x3e4030}));armr.position.y=1.34;armr.castShadow=true;g.add(armr)}if(t.id==="scout"){const hood=new THREE.Mesh(new THREE.ConeGeometry(.23,.45,8),new THREE.MeshLambertMaterial({color:0x1e322d}));hood.position.set(0,2.2,-.03);hood.castShadow=true;g.add(hood)}g.scale.setScalar(t.sc);g.userData.anim={llp,rlp,lap,rap};g.traverse(o=>{if(o.isMesh){o.castShadow=true;o.receiveShadow=true}});return g}
const enemies=[];let eid=0;function spawnEnemy(){const t=pick(),a=Math.random()*Math.PI*2,d=rr(70,HALF-40),x=Math.cos(a)*d,z=Math.sin(a)*d,m=enemyMesh(t);m.position.set(x,terrainY(x,z),z);scene.add(m);enemies.push({id:++eid,type:t,mesh:m,x,z,speed:rr(t.s0,t.s1),hp:t.hp,alive:true,ang:Math.random()*Math.PI*2,wander:rr(.2,2.4),phase:Math.random()*Math.PI*2})}
for(let i=0;i<30;i++)spawnEnemy();
function allyMesh(){const g=new THREE.Group(),u=new THREE.MeshLambertMaterial({color:0x365f85}),d=new THREE.MeshLambertMaterial({color:0x243c54}),skin=new THREE.MeshLambertMaterial({color:0xd8b48a}),gun=new THREE.MeshLambertMaterial({color:0x161616});const t=new THREE.Mesh(new THREE.BoxGeometry(.5,.72,.32),u);t.position.y=1.32;t.castShadow=true;g.add(t);const llp=new THREE.Group();llp.position.set(-.15,.74,0);const ll=new THREE.Mesh(new THREE.CylinderGeometry(.085,.085,.75,7),d);ll.position.y=-.38;llp.add(ll);g.add(llp);const rlp=new THREE.Group();rlp.position.set(.15,.74,0);const rl=new THREE.Mesh(new THREE.CylinderGeometry(.085,.085,.75,7),d);rl.position.y=-.38;rlp.add(rl);g.add(rlp);const lap=new THREE.Group();lap.position.set(-.32,1.5,.04);const la=new THREE.Mesh(new THREE.CylinderGeometry(.06,.06,.58,6),d);la.position.y=-.3;lap.add(la);g.add(lap);const rap=new THREE.Group();rap.position.set(.32,1.5,.12);const ra=new THREE.Mesh(new THREE.CylinderGeometry(.06,.06,.58,6),d);ra.position.y=-.3;rap.add(ra);const r=new THREE.Mesh(new THREE.BoxGeometry(.08,.08,1),gun);r.position.set(.12,-.12,.52);r.rotation.x=-.18;rap.add(r);g.add(rap);const h=new THREE.Mesh(new THREE.SphereGeometry(.21,12,10),skin);h.position.y=2;g.add(h);const cap=new THREE.Mesh(new THREE.CylinderGeometry(.2,.2,.13,10),new THREE.MeshLambertMaterial({color:0x1d2e45}));cap.position.y=2.15;g.add(cap);const dot=new THREE.Mesh(new THREE.SphereGeometry(.06,10,8),new THREE.MeshBasicMaterial({color:0x79c5ff}));dot.position.y=2.42;g.add(dot);g.userData.anim={llp,rlp,lap,rap};g.traverse(o=>{if(o.isMesh){o.castShadow=true;o.receiveShadow=true}});return g}
const ally={mesh:allyMesh(),x:7,z:8,cool:0,phase:0};ally.mesh.position.set(ally.x,terrainY(ally.x,ally.z),ally.z);scene.add(ally.mesh);
const tracers=[];function tracer(s,e,c,t){const g=new THREE.BufferGeometry().setFromPoints([s.clone(),e.clone()]),m=new THREE.LineBasicMaterial({color:c,transparent:true,opacity:.95}),l=new THREE.Line(g,m);scene.add(l);tracers.push({l,ttl:t,max:t})}
function updTracers(dt){for(let i=tracers.length-1;i>=0;i--){const tr=tracers[i];tr.ttl-=dt;tr.l.material.opacity=Math.max(0,tr.ttl/tr.max);if(tr.ttl<=0){scene.remove(tr.l);tr.l.geometry.dispose();tr.l.material.dispose();tracers.splice(i,1)}}}
const windGeo=new THREE.BufferGeometry(),windVerts=[];for(let i=0;i<420;i++)windVerts.push(rr(-65,65),rr(.4,18),rr(-65,65));windGeo.setAttribute("position",new THREE.Float32BufferAttribute(windVerts,3));const wind=new THREE.Points(windGeo,new THREE.PointsMaterial({color:0xffffff,size:.05,transparent:true,opacity:.2}));scene.add(wind);
let audioCtx=null,noiseBuf=null;function ensureAudio(){if(!audioCtx){const AC=window.AudioContext||window.webkitAudioContext;if(!AC)return null;audioCtx=new AC();const len=Math.floor(audioCtx.sampleRate*.35);noiseBuf=audioCtx.createBuffer(1,len,audioCtx.sampleRate);const d=noiseBuf.getChannelData(0);for(let i=0;i<len;i++)d[i]=(Math.random()*2-1)*(1-i/len)}if(audioCtx.state==="suspended")audioCtx.resume();return audioCtx}
function shotSound(lv,allyShot){const c=ensureAudio();if(!c)return;const n=c.currentTime,mg=c.createGain();mg.gain.setValueAtTime((allyShot?.03:.08)*lv,n);mg.connect(c.destination);const o=c.createOscillator();o.type="sawtooth";o.frequency.setValueAtTime(allyShot?185:130,n);o.frequency.exponentialRampToValueAtTime(allyShot?90:58,n+.09);const g=c.createGain();g.gain.setValueAtTime(.001,n);g.gain.exponentialRampToValueAtTime(1,n+.002);g.gain.exponentialRampToValueAtTime(.0001,n+.12);o.connect(g).connect(mg);o.start(n);o.stop(n+.12);if(noiseBuf){const b=c.createBufferSource();b.buffer=noiseBuf;const hp=c.createBiquadFilter();hp.type="highpass";hp.frequency.value=allyShot?700:500;const ng=c.createGain();ng.gain.setValueAtTime(.65,n);ng.gain.exponentialRampToValueAtTime(.0001,n+.06);b.connect(hp).connect(ng).connect(mg);b.start(n);b.stop(n+.08)}}
function reloadTone(done){const c=ensureAudio();if(!c)return;const n=c.currentTime,o=c.createOscillator();o.type=done?"triangle":"square";o.frequency.setValueAtTime(done?420:240,n);o.frequency.exponentialRampToValueAtTime(done?520:170,n+.08);const g=c.createGain();g.gain.setValueAtTime(.0001,n);g.gain.exponentialRampToValueAtTime(done?.09:.05,n+.01);g.gain.exponentialRampToValueAtTime(.0001,n+.12);o.connect(g).connect(c.destination);o.start(n);o.stop(n+.14)}
function hitTone(){const c=ensureAudio();if(!c)return;const n=c.currentTime,o=c.createOscillator();o.type="sine";o.frequency.setValueAtTime(920,n);o.frequency.exponentialRampToValueAtTime(690,n+.05);const g=c.createGain();g.gain.setValueAtTime(.045,n);g.gain.exponentialRampToValueAtTime(.0001,n+.06);o.connect(g).connect(c.destination);o.start(n);o.stop(n+.07)}
const keys={};let locked=false,yaw=0,pitch=0,scoped=false,kills=0,ammo=6,maxAmmo=6,reserve=36,reloading=false,reloadStart=0,reloadEnd=0,breathHeld=false,breath=1,swayT=0,recoil=0,muzzleT=0;
const ray=new THREE.Raycaster(),tempBox=new THREE.Box3();
const muzzleLight=new THREE.PointLight(0xffcf8a,0,22,1.8);muzzleLight.position.set(.16,-.1,-.58);camera.add(muzzleLight);
const muzzleBill=new THREE.Mesh(new THREE.PlaneGeometry(.16,.16),new THREE.MeshBasicMaterial({color:0xffcc6e,transparent:true,opacity:0,depthWrite:false,side:THREE.DoubleSide,blending:THREE.AdditiveBlending}));muzzleBill.position.set(.16,-.1,-.57);camera.add(muzzleBill);
function hud(){ui.kills.textContent=String(kills);ui.ammo.textContent=ammo+" / "+reserve}
function setScope(on){scoped=on;ui.scope.style.display=on?"block":"none";ui.vignette.style.display=on?"block":"none";ui.crosshair.style.display=on?"none":"block";ui.breathWrap.style.display=on?"flex":"none";camera.fov=on?11:75;camera.updateProjectionMatrix()}
function hitFx(){ui.hitmarker.classList.remove("flash");void ui.hitmarker.offsetWidth;ui.hitmarker.classList.add("flash")}
function fireFx(){ui.flash.classList.remove("bang");void ui.flash.offsetWidth;ui.flash.classList.add("bang");ui.weapon.classList.remove("recoil");void ui.weapon.offsetWidth;ui.weapon.classList.add("recoil");ui.muzzle.classList.remove("flash");void ui.muzzle.offsetWidth;ui.muzzle.classList.add("flash");muzzleT=.06}
function kill(en,by){if(!en.alive)return;en.alive=false;kills++;hud();en.mesh.rotation.z=rr(-1.3,1.3);en.mesh.rotation.x=-Math.PI*rr(.3,.58);feed((by==="ALLY"?"ALLY ELIMINATED ":"TARGET ELIMINATED ")+en.type.role,by==="ALLY"?"#8ac6ff":"#ff7f7f");setTimeout(()=>{scene.remove(en.mesh);const i=enemies.indexOf(en);if(i>=0)enemies.splice(i,1);spawnEnemy()},3800)}
function shootPlayer(){if(ammo<=0||reloading){if(!reloading&&ammo<=0)reload();return}ammo--;hud();fireFx();shotSound(1,false);recoil=clamp(recoil+(scoped?.019:.012),0,.05);ray.setFromCamera(new THREE.Vector2(0,0),camera);let hit=null,pnt=null,nd=Infinity;for(const en of enemies){if(!en.alive)continue;tempBox.setFromObject(en.mesh);const p=new THREE.Vector3();if(ray.ray.intersectBox(tempBox,p)){const d=ray.ray.origin.distanceTo(p);if(d<nd){nd=d;hit=en;pnt=p.clone()}}}const s=new THREE.Vector3(.16,-.1,-.58);camera.localToWorld(s);if(hit){const dmg=(scoped?rr(72,108):rr(52,84))*(hit.type.id==="heavy"?.78:1);hit.hp-=dmg;hitFx();hitTone();if(pnt)tracer(s,pnt,0xffd38a,.07);if(hit.hp<=0)kill(hit,"PLAYER")}else{tracer(s,ray.ray.at(260,new THREE.Vector3()),0xffc774,.06)}if(ammo===0)setTimeout(()=>reload(),360)}
function reload(){if(reloading||reserve<=0||ammo===maxAmmo)return;reloading=true;reloadStart=performance.now();reloadEnd=reloadStart+RELOAD_MS;ui.reloadMsg.style.display="block";ui.reloadWrap.style.display="block";ui.reloadMsg.textContent="RELOADING 0%";ui.reloadBar.style.width="0%";reloadTone(false)}
function finishReload(){const take=Math.min(maxAmmo-ammo,reserve);ammo+=take;reserve-=take;reloading=false;ui.reloadMsg.style.display="none";ui.reloadWrap.style.display="none";ui.reloadMsg.textContent="RELOADING 0%";ui.reloadBar.style.width="0%";reloadTone(true);hud()}
ui.lock.addEventListener("click",()=>{ensureAudio();renderer.domElement.requestPointerLock()});
document.addEventListener("pointerlockchange",()=>{locked=document.pointerLockElement===renderer.domElement;ui.lock.style.display=locked?"none":"flex"});
document.addEventListener("mousemove",e=>{if(!locked)return;const s=scoped?.0007:.00195;yaw-=e.movementX*s;pitch-=e.movementY*s;pitch=clamp(pitch,-1.35,1.35)});
document.addEventListener("mousedown",e=>{if(!locked)return;ensureAudio();if(e.button===2)setScope(true);if(e.button===0)shootPlayer()});
document.addEventListener("mouseup",e=>{if(e.button===2)setScope(false)});
document.addEventListener("contextmenu",e=>e.preventDefault());
document.addEventListener("keydown",e=>{keys[e.code]=true;if(e.code==="ShiftLeft"||e.code==="ShiftRight")breathHeld=true;if(e.code==="KeyR")reload();if(["Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code))e.preventDefault()});
document.addEventListener("keyup",e=>{keys[e.code]=false;if(e.code==="ShiftLeft"||e.code==="ShiftRight")breathHeld=false});
function updateEnemies(dt){for(const en of enemies){if(!en.alive)continue;en.wander-=dt;if(en.wander<=0){const tp=Math.atan2(camera.position.x-en.x,camera.position.z-en.z);const ch=en.type.id==="scout"?.57:en.type.id==="heavy"?.3:.42;if(Math.random()<ch)en.ang+=normA(tp-en.ang)*rr(.4,.85);else en.ang+=rr(-1.5,1.5);en.wander=rr(.8,3.2)}en.x+=Math.sin(en.ang)*en.speed*dt;en.z+=Math.cos(en.ang)*en.speed*dt;en.x=clamp(en.x,-LIMIT,LIMIT);en.z=clamp(en.z,-LIMIT,LIMIT);en.phase+=dt*(3+en.speed*2.2);const s=Math.sin(en.phase)*(en.type.id==="heavy"?.5:.65),a=en.mesh.userData.anim;if(a){a.llp.rotation.x=s;a.rlp.rotation.x=-s;a.lap.rotation.x=-s*.52;a.rap.rotation.x=s*.35-.25}en.mesh.position.set(en.x,terrainY(en.x,en.z)+Math.abs(Math.sin(en.phase))*.05,en.z);en.mesh.rotation.y=en.ang+Math.PI}}
function nearest(x,z,maxD){let out=null,dn=maxD;for(const en of enemies){if(!en.alive)continue;const d=Math.hypot(en.x-x,en.z-z);if(d<dn){dn=d;out=en}}return out}
function updateAlly(dt){const f=new THREE.Vector3(-Math.sin(yaw),0,-Math.cos(yaw)),r=new THREE.Vector3(Math.cos(yaw),0,-Math.sin(yaw));const tx=camera.position.x+f.x*-8+r.x*-6,tz=camera.position.z+f.z*-8+r.z*-6,dx=tx-ally.x,dz=tz-ally.z,dist=Math.hypot(dx,dz);if(dist>38){ally.x=camera.position.x-f.x*6-r.x*5;ally.z=camera.position.z-f.z*6-r.z*5}else if(dist>1.2){const step=Math.min(dist,4.2*dt);ally.x+=(dx/dist)*step;ally.z+=(dz/dist)*step}ally.x=clamp(ally.x,-LIMIT,LIMIT);ally.z=clamp(ally.z,-LIMIT,LIMIT);ally.phase+=dt*(dist>1.3?4.8:2.2);ally.mesh.position.set(ally.x,terrainY(ally.x,ally.z)+Math.abs(Math.sin(ally.phase))*.05,ally.z);ally.cool-=dt;const tgt=nearest(ally.x,ally.z,240);if(tgt){ally.mesh.rotation.y=Math.atan2(tgt.x-ally.x,tgt.z-ally.z)}else if(dist>.4){ally.mesh.rotation.y=Math.atan2(dx,dz)}const a=ally.mesh.userData.anim,str=Math.sin(ally.phase)*(dist>1.2?.7:.3);a.llp.rotation.x=str;a.rlp.rotation.x=-str;a.lap.rotation.x=-str*.45;a.rap.rotation.x=str*.3-.25;if(tgt&&ally.cool<=0){const s=new THREE.Vector3(.22,1.34,.5);ally.mesh.localToWorld(s);const e=tgt.mesh.position.clone();e.y+=1.25;tracer(s,e,0x7fc4ff,.08);shotSound(.7,true);tgt.hp-=rr(30,56);ally.cool=rr(.52,.95);if(tgt.hp<=0)kill(tgt,"ALLY")}if(tgt)ui.allyState.textContent="ENGAGING "+tgt.type.role;else if(ally.cool>.2)ui.allyState.textContent="SCANNING";else ui.allyState.textContent="READY"}
function updDist(){let nd=Infinity;for(const en of enemies){if(!en.alive)continue;const d=camera.position.distanceTo(en.mesh.position);if(d<nd)nd=d}ui.distance.textContent=nd<999?Math.round(nd)+" m":"- m"}
function updWind(dt){wind.position.copy(camera.position);const a=windGeo.attributes.position;for(let i=0;i<a.count;i++){a.setX(i,a.getX(i)+dt*2.1);if(a.getX(i)>65)a.setX(i,-65)}a.needsUpdate=true}
function updReload(now){if(!reloading)return;const p=clamp((now-reloadStart)/RELOAD_MS,0,1);ui.reloadBar.style.width=(p*100).toFixed(1)+"%";ui.reloadMsg.textContent="RELOADING "+Math.round(p*100)+"%";if(now>=reloadEnd)finishReload()}
function updMuzzle(dt){if(muzzleT>0){muzzleT-=dt;const k=clamp(muzzleT/.06,0,1);muzzleLight.intensity=3.2*k;muzzleBill.material.opacity=.85*k;const s=.12+.1*(1-k);muzzleBill.scale.set(s,s,1)}else{muzzleLight.intensity=0;muzzleBill.material.opacity=0}}
const clock=new THREE.Clock();
function animate(){requestAnimationFrame(animate);const dt=Math.min(clock.getDelta(),.05),now=performance.now();if(locked){const sp=6.4*dt,f=new THREE.Vector3(-Math.sin(yaw),0,-Math.cos(yaw)),r=new THREE.Vector3(Math.cos(yaw),0,-Math.sin(yaw)),m=new THREE.Vector3();if(keys.KeyW||keys.ArrowUp)m.addScaledVector(f,1);if(keys.KeyS||keys.ArrowDown)m.addScaledVector(f,-1);if(keys.KeyD||keys.ArrowRight)m.addScaledVector(r,1);if(keys.KeyA||keys.ArrowLeft)m.addScaledVector(r,-1);if(m.lengthSq()>0)m.normalize();camera.position.x=clamp(camera.position.x+m.x*sp,-LIMIT,LIMIT);camera.position.z=clamp(camera.position.z+m.z*sp,-LIMIT,LIMIT);camera.position.y=terrainY(camera.position.x,camera.position.z)+PLAYER_H}if(scoped){breath+=breathHeld?-dt*.22:dt*.42;breath=clamp(breath,0,1);ui.breath.style.width=(breath*100).toFixed(1)+"%"}swayT+=dt;const base=scoped?(breathHeld?.00034:.004)*(.22+(1-breath)*.78):0,sx=Math.sin(swayT*1.15)*base+Math.sin(swayT*2.45)*base*.3,sy=Math.cos(swayT*.9)*base*.55;recoil=Math.max(0,recoil-dt*3.2);camera.rotation.order="YXZ";camera.rotation.y=yaw+sx;camera.rotation.x=pitch+sy-recoil;camera.rotation.z=0;const rm=reloading?Math.sin(now*.018)*8:0;ui.weapon.style.transform="translate("+(recoil*420).toFixed(2)+"px,"+(rm+recoil*260).toFixed(2)+"px) rotate("+(rm*.2+recoil*50).toFixed(2)+"deg)";updateEnemies(dt);updateAlly(dt);updDist();updWind(dt);updReload(now);updMuzzle(dt);updTracers(dt);renderer.render(scene,camera)}
hud();animate();
window.addEventListener("resize",()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)});
</script>
</body>
</html>
